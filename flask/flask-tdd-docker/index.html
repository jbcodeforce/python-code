<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../readme/ rel=prev><link href=../../python/pydantic/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.17"><title>Flask Rest microservice with TDD and Docker - Python code studies</title><link rel=stylesheet href=../../assets/stylesheets/main.bcfcd587.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#flask-microservice-with-tdd-and-docker class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Python code studies" class="md-header__button md-logo" aria-label="Python code studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Python code studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Flask Rest microservice with TDD and Docker </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/python-code title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Python code studies" class="md-nav__button md-logo" aria-label="Python code studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Python code studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/python-code title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Introduction </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Basic </span> </a> </li> <li class=md-nav__item> <a href=../../python/python-summary/ class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=../../python/faq/ class=md-nav__link> <span class=md-ellipsis> Advanced </span> </a> </li> <li class=md-nav__item> <a href=../../astronomy/ class=md-nav__link> <span class=md-ellipsis> Astronomy statistics and image processing </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../coding/dev-env/ class=md-nav__link> <span class=md-ellipsis> Development environment </span> </a> </li> <li class=md-nav__item> <a href=../../techno/uv/ class=md-nav__link> <span class=md-ellipsis> Project mgt with uv </span> </a> </li> <li class=md-nav__item> <a href=../../coding/dp/ class=md-nav__link> <span class=md-ellipsis> Design patterns </span> </a> </li> <li class=md-nav__item> <a href=../../coding/references/ class=md-nav__link> <span class=md-ellipsis> Code studies </span> </a> </li> <li class=md-nav__item> <a href=../../coding/building-cli.md class=md-nav__link> <span class=md-ellipsis> Building CLI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Data & AI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Data & AI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../data/pandas/ class=md-nav__link> <span class=md-ellipsis> Pandas </span> </a> </li> <li class=md-nav__item> <a href=../../data/webcrawling/readme/ class=md-nav__link> <span class=md-ellipsis> Web Data </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/ML-studies class=md-nav__link> <span class=md-ellipsis> Python and data sciences </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Web App </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Web App </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../fastapi/ class=md-nav__link> <span class=md-ellipsis> FastAPI </span> </a> </li> <li class=md-nav__item> <a href=../readme/ class=md-nav__link> <span class=md-ellipsis> Flask studies and basic samples </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Flask Rest microservice with TDD and Docker </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Flask Rest microservice with TDD and Docker </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#set-virtual-env class=md-nav__link> <span class=md-ellipsis> Set virtual env </span> </a> </li> <li class=md-nav__item> <a href=#define-and-run-the-flask-app class=md-nav__link> <span class=md-ellipsis> Define and run the flask app </span> </a> </li> <li class=md-nav__item> <a href=#using-docker-and-docker-compose class=md-nav__link> <span class=md-ellipsis> Using docker and docker compose </span> </a> </li> <li class=md-nav__item> <a href=#add-persistence-on-postgresql-and-use-sqlalchemy class=md-nav__link> <span class=md-ellipsis> Add persistence on Postgresql and use SQLAlchemy </span> </a> </li> <li class=md-nav__item> <a href=#add-tests-with-pytest class=md-nav__link> <span class=md-ellipsis> Add tests with pytest </span> </a> <nav class=md-nav aria-label="Add tests with pytest"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#test-coverage class=md-nav__link> <span class=md-ellipsis> Test coverage </span> </a> </li> <li class=md-nav__item> <a href=#code-quality class=md-nav__link> <span class=md-ellipsis> Code quality </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#add-blueprints-template class=md-nav__link> <span class=md-ellipsis> Add Blueprints template </span> </a> </li> <li class=md-nav__item> <a href=#adding-admin-and-model-view class=md-nav__link> <span class=md-ellipsis> Adding admin and model view </span> </a> </li> <li class=md-nav__item> <a href=#production-deployment-with-gunicorn class=md-nav__link> <span class=md-ellipsis> Production deployment with gunicorn </span> </a> </li> <li class=md-nav__item> <a href=#heroku class=md-nav__link> <span class=md-ellipsis> Heroku </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://github.com/jbcodeforce/python-code/tree/master/Flask/firstRESTapp class=md-nav__link> <span class=md-ellipsis> Flask webapp template with docker </span> </a> </li> <li class=md-nav__item> <a href=../../python/pydantic/ class=md-nav__link> <span class=md-ellipsis> Pydantic </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Techno </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Techno </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../techno/aws/ class=md-nav__link> <span class=md-ellipsis> AWS </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/spark-studies class=md-nav__link> <span class=md-ellipsis> Python and Spark </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/kafka-studies class=md-nav__link> <span class=md-ellipsis> Kafka consumer and producer </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/ class=md-nav__link> <span class=md-ellipsis> Back to main </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#set-virtual-env class=md-nav__link> <span class=md-ellipsis> Set virtual env </span> </a> </li> <li class=md-nav__item> <a href=#define-and-run-the-flask-app class=md-nav__link> <span class=md-ellipsis> Define and run the flask app </span> </a> </li> <li class=md-nav__item> <a href=#using-docker-and-docker-compose class=md-nav__link> <span class=md-ellipsis> Using docker and docker compose </span> </a> </li> <li class=md-nav__item> <a href=#add-persistence-on-postgresql-and-use-sqlalchemy class=md-nav__link> <span class=md-ellipsis> Add persistence on Postgresql and use SQLAlchemy </span> </a> </li> <li class=md-nav__item> <a href=#add-tests-with-pytest class=md-nav__link> <span class=md-ellipsis> Add tests with pytest </span> </a> <nav class=md-nav aria-label="Add tests with pytest"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#test-coverage class=md-nav__link> <span class=md-ellipsis> Test coverage </span> </a> </li> <li class=md-nav__item> <a href=#code-quality class=md-nav__link> <span class=md-ellipsis> Code quality </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#add-blueprints-template class=md-nav__link> <span class=md-ellipsis> Add Blueprints template </span> </a> </li> <li class=md-nav__item> <a href=#adding-admin-and-model-view class=md-nav__link> <span class=md-ellipsis> Adding admin and model view </span> </a> </li> <li class=md-nav__item> <a href=#production-deployment-with-gunicorn class=md-nav__link> <span class=md-ellipsis> Production deployment with gunicorn </span> </a> </li> <li class=md-nav__item> <a href=#heroku class=md-nav__link> <span class=md-ellipsis> Heroku </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=flask-microservice-with-tdd-and-docker>Flask microservice with TDD and docker<a class=headerlink href=#flask-microservice-with-tdd-and-docker title="Permanent link">&para;</a></h1> <p>This content is based on the tutorial from <a href=https://testdriven.io/courses/tdd-flask>tesdriven.io</a> and covers:</p> <ul> <li><a href=https://github.com/pypa/pipenv>pipenv for virtual environment and dependencies management</a></li> <li><a href=https://flask-restful.readthedocs.io/en/latest/quickstart.html>Flask Restful</a> where resources are build on top of Flask views</li> <li><a href=https://flask.palletsprojects.com/en/1.1.x/cli/ >Flask CLI</a> tool to run and manage the app from the command line.</li> <li><a href=https://werkzeug.palletsprojects.com/en/0.16.x/debug/#using-the-debugger>Debugging in development mode</a></li> <li><a href=https://mherman.org/presentations/dockercon-2018/ >Docker for python developer</a></li> <li><a href=http://flask-sqlalchemy.pocoo.org/ >Flask-sqlalchemy to support SQLAlchemy in Flask</a></li> <li><a href=http://initd.org/psycopg/ >Psycopg is the most popular PostgreSQL adapter for the Python</a> Here is a quick summary of things learnt.</li> <li><a href=https://hub.docker.com/_/postgres/ >Postgresql docker image</a></li> <li><a href=https://docs.pytest.org/en/latest/ >Pytest for unit and functional testing</a></li> <li><a href=https://flask.palletsprojects.com/en/1.1.x/blueprints/ >Blueprints for organizing code and components</a></li> </ul> <p>The folder <a href=https://github.com/jbcodeforce/python-code/tree/master/Flask/flask-tdd-docker>Flask/flask-tdd-docker</a> includes the training code.</p> <h2 id=set-virtual-env>Set virtual env<a class=headerlink href=#set-virtual-env title="Permanent link">&para;</a></h2> <p>The old way to define virtual environment was to use the following approach:</p> <div class=highlight><pre><span></span><code>python3.7<span class=w> </span>-m<span class=w> </span>venv<span class=w> </span>env
<span class=nb>source</span><span class=w> </span>env/bin/activate
<span class=c1># play with python ...</span>
<span class=c1># Stop with:</span>
deactivate
</code></pre></div> <p>As of today, the approach is to use <code>pipenv</code>, where you update the project and development dependencies in a <code>Pipfile</code>. </p> <div class=highlight><pre><span></span><code>pipenv<span class=w> </span>--python<span class=w> </span><span class=m>3</span>.7
<span class=c1># start the virtual env</span>
pipenv<span class=w> </span>shell
pipenv<span class=w> </span>install<span class=w> </span>--dev
</code></pre></div> <p>Freeze the dependencies:</p> <div class=highlight><pre><span></span><code>pipenv<span class=w> </span>lock<span class=w> </span>-r<span class=w> </span>&gt;<span class=w> </span>requirements.txt
</code></pre></div> <h2 id=define-and-run-the-flask-app>Define and run the flask app<a class=headerlink href=#define-and-run-the-flask-app title="Permanent link">&para;</a></h2> <p>Define a manage.py to represent the app, and use the <a href=https://flask.palletsprojects.com/en/1.1.x/cli/ >Flask CLI</a> shell to manage the app from command line:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>flask.cli</span> <span class=kn>import</span> <span class=n>FlaskGroup</span>
<span class=kn>from</span> <span class=nn>project</span> <span class=kn>import</span> <span class=n>app</span>


<span class=n>cli</span> <span class=o>=</span> <span class=n>FlaskGroup</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=n>cli</span><span class=p>()</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>FLASK_APP</span><span class=o>=</span>project/__init__.py
<span class=c1># use the Flask CLI from inside the app itself</span>
python<span class=w> </span>manage.py<span class=w> </span>run
</code></pre></div> <p>Run in development mode for debugging.</p> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>FLASK_ENV</span><span class=o>=</span>development
python<span class=w> </span>manage.py<span class=w> </span>run
*<span class=w> </span>Serving<span class=w> </span>Flask<span class=w> </span>app<span class=w> </span><span class=s2>&quot;project/__init__.py&quot;</span><span class=w> </span><span class=o>(</span>lazy<span class=w> </span>loading<span class=o>)</span>
*<span class=w> </span>Environment:<span class=w> </span>development
*<span class=w> </span>Debug<span class=w> </span>mode:<span class=w> </span>on
</code></pre></div> <p>With the Flask shell we can explore the data in the application:</p> <div class=highlight><pre><span></span><code>flask<span class=w> </span>shell
</code></pre></div> <h2 id=using-docker-and-docker-compose>Using docker and docker compose<a class=headerlink href=#using-docker-and-docker-compose title="Permanent link">&para;</a></h2> <p>The dockerfile uses alpine linux and non root user. The docker compose uses volume to mount the code into the container. This is a must for a development environment in order to update the container whenever a change to the source code is made. Then build the image using docker compose.</p> <div class=highlight><pre><span></span><code>docker-compose<span class=w> </span>build
<span class=c1># then start in detached mode</span>
docker-compose<span class=w> </span>up<span class=w> </span>-d
<span class=c1># Rebuild the docker images </span>
docker-compose<span class=w> </span>up<span class=w> </span>-d<span class=w> </span>--build
<span class=c1># Access app logs</span>
docker-compose<span class=w> </span>logs
<span class=c1># Access to a python shell to control the flask app</span>
docker-compose<span class=w> </span><span class=nb>exec</span><span class=w> </span>users<span class=w> </span>flask<span class=w> </span>shell
</code></pre></div> <h2 id=add-persistence-on-postgresql-and-use-sqlalchemy>Add persistence on Postgresql and use SQLAlchemy<a class=headerlink href=#add-persistence-on-postgresql-and-use-sqlalchemy title="Permanent link">&para;</a></h2> <p>To initialize the postgresql copy a sql file under /docker-entrypoint-initdb.d (creating the directory if necessary). </p> <p>docker compose section for postgresql:</p> <div class=highlight><pre><span></span><code><span class=nt>users-db</span><span class=p>:</span><span class=w>  </span>
<span class=w>    </span><span class=nt>build</span><span class=p>:</span>
<span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./project/db</span>
<span class=w>      </span><span class=nt>dockerfile</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class=w>    </span><span class=nt>expose</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=postgres</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=postgres</span>
</code></pre></div> <p>Once spun up, PostgreSQL will be available on port 5432. Be sure to include dependencies in the app dockerfile</p> <div class=highlight><pre><span></span><code><span class=c1># install dependencies</span>
RUN<span class=w> </span>apk<span class=w> </span>update<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>apk<span class=w> </span>add<span class=w> </span>--virtual<span class=w> </span>build-deps<span class=w> </span>gcc<span class=w> </span>python-dev<span class=w> </span>musl-dev<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>apk<span class=w> </span>add<span class=w> </span>postgresql-dev<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>apk<span class=w> </span>add<span class=w> </span>netcat-openbsd<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>pip<span class=w> </span>install<span class=w> </span>--upgrade<span class=w> </span>pip<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>pip<span class=w> </span>install<span class=w> </span>--upgrade<span class=w> </span>--user<span class=w> </span>pipenv<span class=w> </span>
</code></pre></div> <p>Also to avoid having the application getting error because it could not contact the database add a <code>entrypoint.sh</code> shell to loop until the database is accessible before starting the python app.</p> <p>To access <code>psql</code>, use the following docker compose command</p> <div class=highlight><pre><span></span><code>docker-compose<span class=w> </span><span class=nb>exec</span><span class=w> </span>users-db<span class=w> </span>psql<span class=w> </span>-U<span class=w> </span>postgres

psql<span class=w> </span><span class=o>(</span><span class=m>11</span>.4<span class=o>)</span>
Type<span class=w> </span><span class=s2>&quot;help&quot;</span><span class=w> </span><span class=k>for</span><span class=w> </span>help.

<span class=nv>postgres</span><span class=o>=</span><span class=c1># \c users_dev</span>
You<span class=w> </span>are<span class=w> </span>now<span class=w> </span>connected<span class=w> </span>to<span class=w> </span>database<span class=w> </span><span class=s2>&quot;users_dev&quot;</span><span class=w> </span>as<span class=w> </span>user<span class=w> </span><span class=s2>&quot;postgres&quot;</span>.
<span class=nv>users_dev</span><span class=o>=</span><span class=c1># \dt</span>
Did<span class=w> </span>not<span class=w> </span>find<span class=w> </span>any<span class=w> </span>relations.
<span class=nv>users_dev</span><span class=o>=</span><span class=c1># \q</span>
</code></pre></div> <p>In the <code>manage.py</code> file, register a new flask CLI command, <code>recreate_db</code>, so that we can run it from the command line like:</p> <div class=highlight><pre><span></span><code>docker-compose exec users python manage.py recreate_db
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># @cli.command(&#39;recreate_db&#39;)</span>
<span class=k>def</span> <span class=nf>recreate_db</span><span class=p>():</span>
    <span class=n>db</span><span class=o>.</span><span class=n>drop_all</span><span class=p>()</span>
    <span class=n>db</span><span class=o>.</span><span class=n>create_all</span><span class=p>()</span>
    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</code></pre></div> <h2 id=add-tests-with-pytest>Add tests with pytest<a class=headerlink href=#add-tests-with-pytest title="Permanent link">&para;</a></h2> <p>While unittest requires test classes, <a href=https://docs.pytest.org/en/latest/getting-started.html>Pytest</a> just requires functions to get up and running.</p> <p>Define fixtures as reusable elements for future tests</p> <p>They have a scope associated with them, which indicates how often the fixture is invoked:</p> <ul> <li>function - once per test function</li> <li>class - once per test class</li> <li>module - once per test module</li> <li>session - once per test session</li> </ul> <p>Some <a href=https://docs.pytest.org/en/latest/fixture.html#fixture-finalization-executing-teardown-code>fixture execution guidance</a></p> <p>Define python script using 'test_' or '_test.py'. Here is an example of functional testing: <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_ping</span><span class=p>(</span><span class=n>test_app</span><span class=p>):</span>
    <span class=n>client</span> <span class=o>=</span> <span class=n>test_app</span><span class=o>.</span><span class=n>test_client</span><span class=p>()</span>
    <span class=n>resp</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;ping&#39;</span><span class=p>)</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
    <span class=k>assert</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
    <span class=k>assert</span> <span class=s1>&#39;pong&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;message&#39;</span><span class=p>]</span>
    <span class=k>assert</span> <span class=s1>&#39;success&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span>
</code></pre></div></p> <p>Execute test with pytest: <code>pytest project/tests/</code> or with docker compose</p> <div class=highlight><pre><span></span><code>docker-compose exec users pytest &quot;project/tests&quot;
</code></pre></div> <h3 id=test-coverage>Test coverage<a class=headerlink href=#test-coverage title="Permanent link">&para;</a></h3> <p>Coverage.py is a popular tool for measuring code coverage in Python-based applications. Now, since we're using Pytest, we'll integrate Coverage.py with Pytest using pytest-cov. In <code>Pipfile</code> add <code>pytest-cov = "&gt;=2.7.1"</code> then do <code>pipenv install</code></p> <p>Then once the image is rebuilt, run the following command to assess the test coverage:</p> <div class=highlight><pre><span></span><code>docker-compose<span class=w> </span><span class=nb>exec</span><span class=w> </span>users<span class=w> </span>pytest<span class=w> </span><span class=s2>&quot;project/tests&quot;</span><span class=w> </span>-p<span class=w> </span>no:warnings<span class=w> </span>--cov<span class=o>=</span><span class=s2>&quot;project&quot;</span>
<span class=c1># or using html page</span>
docker-compose<span class=w> </span><span class=nb>exec</span><span class=w> </span>users<span class=w> </span>pytest<span class=w> </span><span class=s2>&quot;project/tests&quot;</span><span class=w> </span>-p<span class=w> </span>no:warnings<span class=w> </span>--cov<span class=o>=</span><span class=s2>&quot;project&quot;</span><span class=w> </span>--cov-report<span class=w> </span>html
</code></pre></div> <p>Remember: just because you have 100% test coverage doesn’t mean you're testing the right things</p> <h3 id=code-quality>Code quality<a class=headerlink href=#code-quality title="Permanent link">&para;</a></h3> <p>Linting is the process of checking your code for stylistic or programming errors. Although there are a number of commonly used linters for Python, we'll use <a href=https://gitlab.com/pycqa/flake8>Flake8</a> since it combines two other popular linters -- pep8 and pyflakes.</p> <p>In Pipfile add <code>flake8 = "&gt;=3.7.8"</code>, do a <code>pipenv install</code> then freeze the dependencies with <code>pipenv lock -r &gt; requirements.txt</code>, then rebuild the docker image and run flake8:</p> <div class=highlight><pre><span></span><code> docker-compose exec users flake8 project
</code></pre></div> <p>Black helps to format code and apply code formatting:</p> <div class=highlight><pre><span></span><code># check
docker-compose exec users black project --check
# see the propose changes
docker-compose exec users black project --diff
# apply the change
docker-compose exec users black project
</code></pre></div> <h2 id=add-blueprints-template>Add Blueprints template<a class=headerlink href=#add-blueprints-template title="Permanent link">&para;</a></h2> <p><a href=https://flask.palletsprojects.com/en/1.1.x/blueprints/ >Blueprints</a> are self-contained components, used for encapsulating code, templates, and static files. They are apps within the app. For example REST resource can be defined in Blueprint.</p> <p>For example to add an api and a resource, define a new py file, and create a blueprint instance:</p> <div class=highlight><pre><span></span><code><span class=n>users_blueprint</span> <span class=o>=</span> <span class=n>Blueprint</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=vm>__name__</span><span class=p>)</span>
<span class=n>api</span> <span class=o>=</span> <span class=n>Api</span><span class=p>(</span><span class=n>users_blueprint</span><span class=p>)</span>
</code></pre></div> <p>Then define a class with functions to support the expected Resource, and add this class to a url to the api.</p> <div class=highlight><pre><span></span><code>class UsersList(Resource):
    def get(self):
        ...
    def post(self):
        ...
api.add_resource(UsersList, &#39;/users&#39;)
</code></pre></div> <p>Finally register the resouce to the flask application:</p> <div class=highlight><pre><span></span><code>    from project.api.users import users_blueprint
    app.register_blueprint(users_blueprint)
</code></pre></div> <p>See the code in <a href=https://github.com/jbcodeforce/python-code/blob/master/flask-tdd-docker/project/api/users.py>users.py</a> and <a href=https://github.com/jbcodeforce/python-code/blob/master/flask-tdd-docker/project/__init__.py><strong>init</strong>.py</a></p> <p>Factory to create an app needs to be named <code>create_app</code>. </p> <h2 id=adding-admin-and-model-view>Adding admin and model view<a class=headerlink href=#adding-admin-and-model-view title="Permanent link">&para;</a></h2> <h2 id=production-deployment-with-gunicorn>Production deployment with gunicorn<a class=headerlink href=#production-deployment-with-gunicorn title="Permanent link">&para;</a></h2> <p>Create a specific <code>Dockerfile.prod</code> and set the environment variable to run Flask in production mode and use gunicorn as container, and run under a user that is not root. </p> <div class=highlight><pre><span></span><code>ENV FLASK_ENV production
ENV APP_SETTINGS project.config.ProductionConfig

# add and run as non-root user
RUN adduser -D myuser
USER myuser

# run gunicorn
CMD gunicorn --bind 0.0.0.0:$PORT manage:app
</code></pre></div> <h2 id=heroku>Heroku<a class=headerlink href=#heroku title="Permanent link">&para;</a></h2> <p>Using heroku CLI.</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>heroku<span class=w> </span>login
<span class=c1># create a app</span>
$<span class=w> </span>heroku<span class=w> </span>create<span class=w> </span>
Creating<span class=w> </span>app...<span class=w> </span><span class=k>done</span>,<span class=w> </span>murmuring-shore-37331
https://murmuring-shore-37331.herokuapp.com/<span class=w> </span><span class=p>|</span><span class=w> </span>https://git.heroku.com/murmuring-shore-37331.git

<span class=c1># login to docker private registry</span>
$<span class=w> </span>heroku<span class=w> </span>container:login

<span class=c1># create a postgresql with the hobby-dev plan</span>
$<span class=w> </span>heroku<span class=w> </span>addons:create<span class=w> </span>heroku-postgresql:hobby-dev<span class=w> </span>--app<span class=w> </span>murmuring-shore-37331

Creating<span class=w> </span>heroku-postgresql:hobby-dev<span class=w> </span>on<span class=w> </span>murmuring-shore-37331...<span class=w> </span>free
Database<span class=w> </span>has<span class=w> </span>been<span class=w> </span>created<span class=w> </span>and<span class=w> </span>is<span class=w> </span>available
<span class=w> </span>!<span class=w> </span>This<span class=w> </span>database<span class=w> </span>is<span class=w> </span>empty.<span class=w> </span>If<span class=w> </span>upgrading,<span class=w> </span>you<span class=w> </span>can<span class=w> </span>transfer
<span class=w> </span>!<span class=w> </span>data<span class=w> </span>from<span class=w> </span>another<span class=w> </span>database<span class=w> </span>with<span class=w> </span>pg:copy
Created<span class=w> </span>postgresql-horizontal-04149<span class=w> </span>as<span class=w> </span>DATABASE_URL
Use<span class=w> </span>heroku<span class=w> </span>addons:docs<span class=w> </span>heroku-postgresql<span class=w> </span>to<span class=w> </span>view<span class=w> </span>documentation

<span class=c1># Get database URL</span>
heroku<span class=w> </span>config:get<span class=w> </span>DATABASE_URL<span class=w> </span>--app<span class=w> </span>murmuring-shore-37331
</code></pre></div> <p>The containers used at Heroku are called “dynos.” <a href=https://www.heroku.com/dynos>Dynos</a> are isolated, virtualized Linux containers that are designed to execute code based on a user-specified command.</p> <p>To build an image for the docker private registry, using the web dyno, that is free.</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>docker<span class=w> </span>build<span class=w> </span>-f<span class=w> </span>Dockerfile.prod<span class=w> </span>-t<span class=w> </span>registry.heroku.com/murmuring-shore-37331/web<span class=w> </span>.
<span class=c1># publish</span>
$<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>registry.heroku.com/murmuring-shore-37331/web:latest
<span class=c1># test locally</span>
$<span class=w> </span>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>flask-tdd<span class=w> </span>-e<span class=w> </span><span class=s2>&quot;PORT=8765&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5002</span>:8765<span class=w> </span>registry.heroku.com/murmuring-shore-37331/web:latest

<span class=c1># Release the image, meaning the app will be based on the container image</span>
$<span class=w> </span>heroku<span class=w> </span>container:release<span class=w> </span>web<span class=w> </span>--app<span class=w> </span>murmuring-shore-37331
Releasing<span class=w> </span>images<span class=w> </span>web<span class=w> </span>to<span class=w> </span>murmuring-shore-37331...<span class=w> </span><span class=k>done</span>
</code></pre></div> <p>Once the image is "released", the app is accessible via <code>https://murmuring-shore-37331.herokuapp.com/ping</code></p> <p>Access to logs: <code>heroku logs --app murmuring-shore-37331</code></p> <p>The users are not yet created, so we can run the CLI <code>heroku run</code>:</p> <div class=highlight><pre><span></span><code><span class=c1># create DB</span>
<span class=n>heroku</span> <span class=n>run</span> <span class=n>python</span> <span class=n>manage</span><span class=o>.</span><span class=n>py</span> <span class=n>recreate_db</span> <span class=o>--</span><span class=n>app</span> <span class=n>murmuring</span><span class=o>-</span><span class=n>shore</span><span class=o>-</span><span class=mi>37331</span>
<span class=c1># populate the data</span>
<span class=n>heroku</span> <span class=n>run</span> <span class=n>python</span> <span class=n>manage</span><span class=o>.</span><span class=n>py</span> <span class=n>seed_db</span> <span class=o>--</span><span class=n>app</span> <span class=n>murmuring</span><span class=o>-</span><span class=n>shore</span><span class=o>-</span><span class=mi>37331</span>
<span class=c1># Access the database with psql: </span>
<span class=c1># 1. start a local docker postgresql with psql</span>
<span class=n>docker</span> <span class=n>run</span> <span class=o>-</span><span class=n>ti</span> <span class=n>postgresql</span> <span class=n>bash</span>
<span class=o>&gt;</span> <span class=n>psql</span> <span class=n>postgres</span><span class=p>:</span><span class=o>//....</span>
<span class=o>&gt;</span> <span class=n>PSQL</span><span class=p>:</span>
</code></pre></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.1e8ae164.min.js></script> </body> </html>